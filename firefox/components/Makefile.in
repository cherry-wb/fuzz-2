XULRUNNER = xulrunner
XPIDL=/usr/lib/xulrunner/xpidl
XULIDL=/usr/share/idl/xulrunner
BUILD=../build
DIST=../dist

CC = g++

CFLAGS = -I/usr/include -I/usr/include/xulrunner/java -I/usr/include/xulrunner/plugin -I/usr/include/xulrunner -I/usr/include/xulrunner/xpcom -I/usr/include/xulrunner/string -I$(BUILD) 
LDFLAGS += -L/usr/lib -L/usr/lib/xulrunner 

ifneq (@RDFA_INCLUDE_DIRECTORY@,/usr/include)
CFLAGS += -I@RDFA_INCLUDE_DIRECTORY@
LDFLAGS += -L@RDFA_LIB_DIRECTORY@
endif

CFLAGS += -Wall -g -DMOZILLA_STRICT_API

ifeq (@OS@,mingw32)
XPIDL=/usr/lib/gecko-sdk/bin/xpidl
XULIDL=/usr/lib/gecko-sdk/idl
CFLAGS += -I/usr/lib/gecko-sdk/include
LDFLAGS += -lxpcom -lplds4 -lplc4 -lnspr4 -lexpat -ltidy @RDFA_LIB_DIRECTORY@/rdfa.lib 
CFLAGS += -DXP_WIN=1 -D_WINDOWS=1 -D_WIN32=1 -DWIN32=1 -DXP_WIN=1 -DXP_WIN32=1 -DHW_THREADS=1 -DWINVER=0x400 -D_WIN32_WINNT=0x400 -DSTDC_HEADERS=1 -DWIN32_LEAN_AND_MEAN=1
LIBS = $(DIST)/fuzzbot-components.dll
else
CFLAGS += -I/usr/include/nspr
LDFLAGS += -lxpcom -lplds4 -lplc4 -lnspr4 -ltidy -lpthread -ldl @RDFA_LIB_DIRECTORY@/librdfa.a
LIBS = $(DIST)/fuzzbot-components.so
CFLAGS += -DXP_UNIX
endif

fuzzbot_plugin_objects = $(BUILD)/FuzzbotExtension.o

all_objects = $(fuzzbot_plugin_objects)

.PHONY: make_dirs

all: make_dirs  $(DIST)/IFuzzbotExtension.xpt $(LIBS) 

make_dirs:
	mkdir -p ../build
	mkdir -p ../dist

clean:
	$(RM) -rf $(BUILD) $(DIST)

$(BUILD)/FuzzbotExtension.o : $(BUILD)/IFuzzbotExtension.h 

$(DIST)/fuzzbot-components.so $(DIST)/fuzzbot-components.dll: $(fuzzbot_plugin_objects)
	$(CC) -shared -o $(DIST)/$@ $^ $(LDFLAGS)

$(BUILD)/%.o: %.cpp
	$(CC) -c $(CFLAGS) $< -o $@

$(BUILD)/%.h: %.idl
	$(XPIDL) -m header -I $(XULIDL)  -o $(basename $@) $<

$(DIST)/%.xpt: %.idl
	$(XPIDL) -m typelib -I $(XULIDL) -o $(basename $@) $<

%.html: %.idl
	$(XPIDL) -m doc -I $(XULIDL) -o $(BUILD) $<
