XULRUNNER = xulrunner
XPIDL=/usr/lib/xulrunner/xpidl
XULIDL=/usr/share/idl/xulrunner
BUILD=../build
DIST=../dist

CC = g++

CFLAGS = -I/usr/include -I/usr/include/xulrunner/java -I/usr/include/xulrunner/plugin -I/usr/include/nspr -I/usr/include/xulrunner -I/usr/include/xulrunner/xpcom -I/usr/include/xulrunner/string
CFLAGS += -I$(BUILD) -Wall -g -DMOZILLA_STRICT_API

ifeq (@OS@,mingw32)
LDFLAGS = -L/usr/lib -L/usr/lib/xulrunner -lxpcom -lplds4 -lplc4 -lnspr4 -lexpat /usr/lib/rdfa.lib 
CFLAGS += -DXP_WIN
LIBS = $(DIST)/fuzzbot-components.dll
else
LDFLAGS = -L/usr/lib/xulrunner -lxpcom -lplds4 -lplc4 -lnspr4 -lpthread -ldl /usr/lib/librdfa.a
LIBS = $(DIST)/fuzzbot-components.so
CFLAGS += -DXP_UNIX
endif

fuzzbot_plugin_objects = $(BUILD)/FuzzbotExtension.o

all_objects = $(fuzzbot_plugin_objects)

.PHONY: make_dirs

all: make_dirs $(LIBS) $(DIST)/IFuzzbotExtension.xpt

make_dirs:
	mkdir -p ../build
	mkdir -p ../dist

clean:
	$(RM) -rf $(BUILD) $(DIST)

$(BUILD)/FuzzbotExtension.o : $(BUILD)/IFuzzbotExtension.h 

$(DIST)/fuzzbot-components.so $(DIST)/fuzzbot-components.dll: $(fuzzbot_plugin_objects)
	$(CC) -shared -o $(DIST)/$@ $^ $(LDFLAGS)

$(BUILD)/%.o: %.cpp
	$(CC) -c $(CFLAGS) $< -o $@

$(BUILD)/%.h: %.idl
	$(XPIDL) -m header -I $(XULIDL)  -o $(basename $@) $<

$(DIST)/%.xpt: %.idl
	$(XPIDL) -m typelib -I $(XULIDL) -o $(basename $@) $<

%.html: %.idl
	$(XPIDL) -m doc -I $(XULIDL) -o $(BUILD) $<
