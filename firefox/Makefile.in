NAME=fuzzbot
ZIPEXCLUDE=-x \*.swp -x \*.svn/\* -x \*~ \*.svg

.PHONY: all help

build-executables: build-libraries xpi
build-directories:
build-objects:

build-libraries:
	cd components && $(MAKE) all

ifeq (@OS@,mingw32)
CP_FLAGS = -a
xpi: build-libraries xpi-windows
endif
ifeq (@OS@,darwin8.11.1)
CP_FLAGS = -p
xpi: build-libraries xpi-darwin
endif
ifeq (@OS@,linux-gnu)
CP_FLAGS = -a
xpi: build-libraries xpi-linux
endif

xpi-common:
	cp $(CP_FLAGS) dist/*.xpt extension/components/
	-$(RM) extension/chrome/$(NAME).jar
	cd extension/chrome/$(NAME) && \
		zip -r ../$(NAME).jar content locale $(ZIPEXCLUDE)

xpi-windows: xpi-common
	$(RM) dist/fuzzbot-windows.xpi
	mkdir -p extension/platform/WINNT_x86-msvc/content
	mkdir -p extension/platform/WINNT_x86-msvc/components
	mkdir -p extension/components
	cp -a dist/fuzzbot-components.dll \
		extension/platform/WINNT_x86-msvc/components
	cd extension && \
	zip ../dist/fuzzbot-windows.xpi chrome.manifest chrome/$(NAME).jar \
		defaults/preferences/fuzzbot.js \
		install.rdf components/*.xpt \
		`find platform` \
		$(ZIPEXCLUDE)

xpi-darwin: xpi-common
	$(RM) dist/fuzzbot-darwin.xpi
	mkdir -p extension/platform/Darwin_x86-gcc3/content
	mkdir -p extension/platform/Darwin_x86-gcc3/components
	mkdir -p extension/components
	cp -p dist/fuzzbot-components.dylib \
		extension/platform/Darwin_x86-gcc3/components
	cd extension && \
	zip ../dist/fuzzbot-darwin.xpi chrome.manifest chrome/$(NAME).jar \
		defaults/preferences/fuzzbot.js \
		install.rdf components/*.xpt \
		`find platform` \
		$(ZIPEXCLUDE)

xpi-linux: xpi-common
	$(RM) dist/fuzzbot-linux.xpi
	mkdir -p extension/platform/Linux_x86-gcc3/content
	mkdir -p extension/platform/Linux_x86-gcc3/components
	mkdir -p extension/components
	cp -a dist/fuzzbot-components.so \
		extension/platform/Linux_x86-gcc3/components
	cd extension && \
	zip ../dist/fuzzbot-linux.xpi chrome.manifest chrome/$(NAME).jar \
		defaults/preferences/fuzzbot.js \
		install.rdf components/*.xpt \
		`find platform` \
		$(ZIPEXCLUDE)

clean: clean-xpi
	rm -rf build
	rm -rf dist

clean-xpi:
	$(RM) dist/fuzzbot-*.xpi
	$(RM) extension/chrome/$(NAME).jar
	$(RM) extension/components/*.xpt
	$(RM) -rf extension/platform/*
